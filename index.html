<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chess Arena Pi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#1d1f27;
      --fg:#e8e8ee;
      --card:#2a2d3a;
      --accent:#7d7aff;
      --square-light:#f0d9b5;
      --square-dark:#b58863;
      --frame:#6f4e1f;
      --wood-light:#d5a64f;
      --wood-dark:#b07f2d;
    }
    *{box-sizing:border-box;}
    body {
      margin:0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:1.5rem;
      gap:30px;
      overflow-x:hidden;
    }
    .card {
      width:100%;
      max-width:660px;
      background: var(--card);
      border-radius:18px;
      padding:2rem 1.75rem 2.5rem;
      box-shadow:0 50px 120px -10px rgba(0,0,0,0.5);
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      position:relative;
    }
    .logo {
      width:140px;
      height:140px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0;
      opacity:0;
      animation: bounceIn .7s ease-out forwards, pulse 2.5s ease-in-out .7s 0.7s infinite;
    }
    @keyframes bounceIn {
      0% { transform: translateY(50px) scale(.7); opacity:0; }
      60% { transform: translateY(-6px) scale(1.08); opacity:1; }
      100% { transform: translateY(0) scale(1); }
    }
    @keyframes pulse {
      0%,100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .welcome {
      font-size:3rem;
      font-weight:700;
      margin:0;
      line-height:1;
    }
    .sub {
      font-size:1.1rem;
      margin:0;
      text-transform:uppercase;
      opacity:.85;
      letter-spacing:1px;
    }
    .btn {
      cursor:pointer;
      padding:16px 28px;
      border:none;
      border-radius:14px;
      font-size:1.3rem;
      font-weight:700;
      background: linear-gradient(135deg,var(--accent),#8f9fff);
      color:#fff;
      margin-top:8px;
      min-width:200px;
      box-shadow:0 25px 80px -5px rgba(127,127,255,0.6);
      transition:filter .15s;
    }
    .btn:active {filter:brightness(.9);}
    .small-text {
      font-size:0.85rem;
      margin-top:6px;
      opacity:.85;
    }
    .board-container {
      display:none;
      position:relative;
      width:100%;
      max-width:700px;
      padding:20px;
      background: linear-gradient(135deg,var(--wood-light) 0%, var(--wood-dark) 100%);
      border-radius:18px;
      box-shadow:0 60px 140px -10px rgba(0,0,0,0.5);
      margin-top:10px;
      animation: popIn .4s cubic-bezier(.4,0,.2,1) forwards;
    }
    @keyframes popIn {
      0% { transform: scale(.7); opacity:0; }
      60% { transform: scale(1.05); opacity:1; }
      100% { transform: scale(1); }
    }
    .board-frame {
      background: var(--frame);
      padding:8px;
      border-radius:12px;
      display:flex;
      justify-content:center;
    }
    .board {
      position:relative;
      width:560px;
      aspect-ratio:1;
      display:grid;
      grid-template: repeat(8,1fr) / repeat(8,1fr);
      border-radius:8px;
      overflow:hidden;
      box-shadow: inset 0 0 40px rgba(0,0,0,0.3);
    }
    .square {
      position:relative;
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0;
      user-select:none;
    }
    .square.light { background: var(--square-light); }
    .square.dark { background: var(--square-dark); }
    .piece {
      width:80%;
      height:80%;
      cursor:grab;
      touch-action:none;
      position:relative;
    }
    .highlight {
      outline:3px solid #ffd33f;
      outline-offset:-3px;
      border-radius:4px;
    }
    .status {
      margin-top:12px;
      font-size:1rem;
      font-weight:600;
    }
    .note {
      font-size:0.65rem;
      margin-top:6px;
      opacity:.6;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="card" aria-label="Welcome card">
    <div class="logo" aria-label="Pawn logo">
      <svg width="96" height="96" viewBox="0 0 64 64" aria-hidden="true" style="display:block; color:#e8e8ee;">
        <circle cx="32" cy="16" r="10" fill="currentColor"/>
        <path d="M22 52c0-8 20-8 20 0H22z" fill="currentColor"/>
        <path d="M24 44h16v8H24z" fill="currentColor"/>
        <path d="M16 56h32v4H16z" fill="currentColor"/>
      </svg>
    </div>
    <div class="welcome">welcome</div>
    <div class="sub">The Chess Arena Pi</div>
    <button class="btn" id="start-btn">Start</button>
    <div class="small-text" id="start-msg">Tap start to begin the game.</div>
  </div>

  <div class="board-container" id="board-container" aria-label="Chess board area">
    <div class="board-frame">
      <div class="board" id="board" aria-label="Chessboard"></div>
    </div>
    <div class="status" id="status">...</div>
    <div class="note">White starts. Drag/tap to move. Basic rules enforced.</div>
  </div>

  <script>
    // audio context
    let audioCtx;
    function ensureCtx() { if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }

    function playPinDrop() {
      ensureCtx();
      const ctx = audioCtx;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "triangle";
      osc.frequency.setValueAtTime(900, ctx.currentTime);
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.exponentialRampToValueAtTime(250, ctx.currentTime + 0.1);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
      osc.start();
      osc.stop(ctx.currentTime + 0.25);
    }
    function playClick() {
      ensureCtx();
      const ctx = audioCtx;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(600, ctx.currentTime);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.07);
    }
    function playMoveTone() {
      ensureCtx();
      const ctx = audioCtx;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.setValueAtTime(480, ctx.currentTime);
      gain.gain.setValueAtTime(0.08, ctx.currentTime);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.05);
    }
    function playLoserKwang() {
      ensureCtx();
      const ctx = audioCtx;
      const hit = (timeOffset) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "square";
        osc.frequency.setValueAtTime(900, ctx.currentTime + timeOffset);
        gain.gain.setValueAtTime(0.15, ctx.currentTime + timeOffset);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + timeOffset + 0.07);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + timeOffset + 0.15);
        osc.start(ctx.currentTime + timeOffset);
        osc.stop(ctx.currentTime + timeOffset + 0.2);
      };
      hit(0);
      hit(0.2);
      hit(0.4);
    }

    // confetti (simple)
    function launchConfetti() {
      const duration = 3000;
      const end = Date.now() + duration;
      const colors = ["#fffa65","#ff8c42","#7cffcb","#c27eff"];
      const create = () => {
        const conf = document.createElement("div");
        conf.style.position="fixed";
        conf.style.zIndex=999;
        conf.style.pointerEvents="none";
        conf.style.width="10px"; conf.style.height="10px";
        conf.style.background=colors[Math.floor(Math.random()*colors.length)];
        conf.style.borderRadius="50%";
        conf.style.left=(Math.random()*100)+"%";
        conf.style.top="-10px";
        conf.style.opacity=1;
        document.body.appendChild(conf);
        const gravity=0.1 + Math.random()*0.15;
        let vy=2+Math.random()*3;
        let vx=(Math.random()-0.5)*3;
        const fall = () => {
          vy += gravity;
          const top = parseFloat(conf.style.top);
          const left = parseFloat(conf.style.left);
          conf.style.top = (top + vy)+"px";
          conf.style.left = (left + vx)+"px";
          vy *= 0.99;
          vx *= 0.99;
          conf.style.opacity = Math.max(0, parseFloat(conf.style.opacity) - 0.01);
          if (top > window.innerHeight || conf.style.opacity<=0) {
            conf.remove();
          } else {
            requestAnimationFrame(fall);
          }
        };
        fall();
      };
      const interval = setInterval(() => {
        if (Date.now() > end) { clearInterval(interval); return; }
        for (let i=0;i<8;i++) create();
      }, 100);
    }

    // Chess setup (simplified FIDE, no castling/en passant)
    const initialFEN = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w";
    let gameState = null;
    const pieceSVGs = {
      P: `<svg viewBox="0 0 45 45" aria-label="White Pawn"><circle cx="22.5" cy="12" r="6" fill="#ffffff"/><path d="M12 33c0-8 21-8 21 0H12z" fill="#ffffff"/><path d="M14 27h17v6H14z" fill="#f0f0ff"/><path d="M8 36h29v3H8z" fill="#d1d1f0"/></svg>`,
      R: `<svg viewBox="0 0 45 45" aria-label="White Rook"><rect x="12" y="12" width="21" height="6" fill="#ffffff"/><path d="M12 18h21v15H12z" fill="#ffffff"/><path d="M10 33h25v4H10z" fill="#d1d1f0"/></svg>`,
      N: `<svg viewBox="0 0 45 45" aria-label="White Knight"><path d="M22.5 12c-6 0-12 8-12 12v7h24v-7c0-4-6-12-12-12z" fill="#ffffff"/><circle cx="22.5" cy="30" r="3" fill="#d1d1f0"/></svg>`,
      B: `<svg viewBox="0 0 45 45" aria-label="White Bishop"><path d="M22.5 12c-5 0-12 8-12 12v7h24v-7c0-4-7-12-12-12z" fill="#ffffff"/><circle cx="22.5" cy="30" r="3" fill="#d1d1f0"/></svg>`,
      Q: `<svg viewBox="0 0 45 45" aria-label="White Queen"><circle cx="22.5" cy="12" r="5" fill="#ffffff"/><path d="M12 18h21v15H12z" fill="#ffffff"/><path d="M10 33h25v4H10z" fill="#d1d1f0"/></svg>`,
      K: `<svg viewBox="0 0 45 45" aria-label="White King"><path d="M20 12h5v5h-5z" fill="#ffffff"/><path d="M12 18h21v15H12z" fill="#ffffff"/><path d="M10 33h25v4H10z" fill="#d1d1f0"/></svg>`,
      p: `<svg viewBox="0 0 45 45" aria-label="Black Pawn"><circle cx="22.5" cy="12" r="6" fill="#1f1f28"/><path d="M12 33c0-8 21-8 21 0H12z" fill="#1f1f28"/><path d="M14 27h17v6H14z" fill="#2f2f3a"/><path d="M8 36h29v3H8z" fill="#3f3f55"/></svg>`,
      r: `<svg viewBox="0 0 45 45" aria-label="Black Rook"><rect x="12" y="12" width="21" height="6" fill="#1f1f28"/><path d="M12 18h21v15H12z" fill="#1f1f28"/><path d="M10 33h25v4H10z" fill="#3f3f55"/></svg>`,
      n: `<svg viewBox="0 0 45 45" aria-label="Black Knight"><path d="M22.5 12c-6 0-12 8-12 12v7h24v-7c0-4-6-12-12-12z" fill="#1f1f28"/><circle cx="22.5" cy="30" r="3" fill="#3f3f55"/></svg>`,
      b: `<svg viewBox="0 0 45 45" aria-label="Black Bishop"><path d="M22.5 12c-5 0-12 8-12 12v7h24v-7c0-4-7-12-12-12z" fill="#1f1f28"/><circle cx="22.5" cy="30" r="3" fill="#3f3f55"/></svg>`,
      q: `<svg viewBox="0 0 45 45" aria-label="Black Queen"><circle cx="22.5" cy="12" r="5" fill="#1f1f28"/><path d="M12 18h21v15H12z" fill="#1f1f28"/><path d="M10 33h25v4H10z" fill="#3f3f55"/></svg>`,
      k: `<svg viewBox="0 0 45 45" aria-label="Black King"><path d="M20 12h5v5h-5z" fill="#1f1f28"/><path d="M12 18h21v15H12z" fill="#1f1f28"/><path d="M10 33h25v4H10z" fill="#3f3f55"/></svg>`
    };

    function loadFEN(fen) {
      const parts = fen.split(" ");
      const rows = parts[0].split("/");
      const board = [];
      for (let r=0;r<8;r++) {
        const row=[];
        for (let i=0;i<rows[r].length;i++) {
          const c=rows[r][i];
          if (/\d/.test(c)) {
            const cnt=parseInt(c,10);
            for (let j=0;j<cnt;j++) row.push(null);
          } else row.push(c);
        }
        board.push(row);
      }
      return { board, turn: parts[1]==="w"?"w":"b" };
    }
    function cloneState(s){ return { board: s.board.map(r=>r.slice()), turn: s.turn }; }
    function inBounds(r,c){return r>=0&&r<8&&c>=0&&c<8;}
    function coordToRC(coord){
      return [8 - parseInt(coord[1],10), coord[0].charCodeAt(0)-97];
    }
    function rcToCoord([r,c]){
      return String.fromCharCode(97 + c)+(8 - r);
    }

    function generateMoves(state, from) {
      const moves=[];
      const [fr,fc]=from;
      const piece=state.board[fr][fc];
      if (!piece) return moves;
      const isWhite = piece===piece.toUpperCase();
      const opponent = isWhite ? /[a-z]/ : /[A-Z]/;
      if (piece.toUpperCase()==="P") {
        const dir = piece==="P"? -1:1;
        if (inBounds(fr+dir,fc) && !state.board[fr+dir][fc]) {
          moves.push([fr+dir,fc]);
          const startRank = piece==="P"?6:1;
          if (fr===startRank && !state.board[fr+2*dir][fc]) moves.push([fr+2*dir,fc]);
        }
        for (let dc of [-1,1]) {
          const nr=fr+dir, nc=fc+dc;
          if (inBounds(nr,nc) && state.board[nr][nc] && opponent.test(state.board[nr][nc])) moves.push([nr,nc]);
        }
      } else if (piece.toUpperCase()==="N") {
        const deltas=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];
        deltas.forEach(d=>{
          const nr=fr+d[0], nc=fc+d[1];
          if (!inBounds(nr,nc)) return;
          const target=state.board[nr][nc];
          if (!target || opponent.test(target)) moves.push([nr,nc]);
        });
      } else if (["B","R","Q","K"].includes(piece.toUpperCase())) {
        const vectors = {
          B: [[-1,-1],[-1,1],[1,-1],[1,1]],
          R: [[-1,0],[1,0],[0,-1],[0,1]],
          Q: [[-1,-1],[-1,1],[1,-1],[1,1],[-1,0],[1,0],[0,-1],[0,1]],
          K: [[-1,-1],[-1,1],[1,-1],[1,1],[-1,0],[1,0],[0,-1],[0,1]],
        }[piece.toUpperCase()];
        vectors.forEach(v=>{
          let nr=fr+v[0], nc=fc+v[1];
          while (inBounds(nr,nc)) {
            const target=state.board[nr][nc];
            if (!target) {
              moves.push([nr,nc]);
            } else {
              if (opponent.test(target)) moves.push([nr,nc]);
              break;
            }
            if (piece.toUpperCase()==="K") break;
            nr+=v[0]; nc+=v[1];
          }
        });
      }
      return moves;
    }

    function isKingInCheck(state,color){
      let king=null;
      const target = color==="w"?"K":"k";
      for (let r=0;r<8;r++) for (let c=0;c<8;c++) if (state.board[r][c]===target) king=[r,c];
      if (!king) return true;
      const opponentColor = color==="w"?"b":"w";
      for (let r=0;r<8;r++) for (let c=0;c<8;c++){
        const p=state.board[r][c];
        if (!p) continue;
        const isWhite=p===p.toUpperCase();
        if ((opponentColor==="w"&&isWhite)||(opponentColor==="b"&&!isWhite)){
          const moves=generateMoves(state,[r,c]);
          if (moves.some(m=>m[0]===king[0]&&m[1]===king[1])) return true;
        }
      }
      return false;
    }

    function movePiece(state,from,to){
      const piece=state.board[from[0]][from[1]];
      if (!piece) return false;
      const moves=generateMoves(state,from);
      const valid=moves.some(m=>m[0]===to[0]&&m[1]===to[1]);
      if (!valid) return false;
      const newState=cloneState(state);
      if ((piece==="P"&&to[0]===0)||(piece==="p"&&to[0]===7)){
        newState.board[to[0]][to[1]] = piece==="P"?"Q":"q";
      } else newState.board[to[0]][to[1]] = piece;
      newState.board[from[0]][from[1]] = null;
      newState.turn = state.turn==="w"?"b":"w";
      if (isKingInCheck(newState, state.turn)) return false; // moving into own check
      Object.assign(state,newState);
      return true;
    }

    function hasLegalMoves(state){
      for (let r=0;r<8;r++) for (let c=0;c<8;c++){
        const p=state.board[r][c];
        if (!p) continue;
        const isWhite=p===p.toUpperCase();
        if ((state.turn==="w"&&isWhite)||(state.turn==="b"&&!isWhite)){
          const moves=generateMoves(state,[r,c]);
          for (let m of moves){
            const t=cloneState(state);
            if (movePiece(t,[r,c],m)) return true;
          }
        }
      }
      return false;
    }

    // Render
    const boardEl=document.getElementById("board");
    const statusEl=document.getElementById("status");

    function updateStatus(state){
      const inCheck=isKingInCheck(state,state.turn);
      const legal=hasLegalMoves(state);
      if (!legal){
        const loser= state.turn==="w"?"White":"Black";
        const winner= state.turn==="w"?"Black":"White";
        statusEl.textContent = `${loser} is checkmated. ${winner} wins!`;
        // celebration & loser sound
        launchConfetti();
        playLoserKwang();
      } else {
        statusEl.textContent = `${state.turn==="w"?"White":"Black"}${inCheck?" (in check)":""} to move.`;
      }
    }

    function render(state){
      boardEl.innerHTML="";
      for (let r=0;r<8;r++){
        for (let c=0;c<8;c++){
          const sq=document.createElement("div");
          const isLight=((r+c)%2===0);
          sq.className="square "+(isLight?"light":"dark");
          sq.dataset.coord=rcToCoord([r,c]);
          if (state.board[r][c]){
            const pw=document.createElement("div");
            pw.className="piece";
            pw.dataset.piece=state.board[r][c];
            pw.innerHTML=pieceSVGs[state.board[r][c]]||"";
            sq.appendChild(pw);
          }
          boardEl.appendChild(sq);
        }
      }
      updateStatus(state);
    }

    function clearHighlights(){
      boardEl.querySelectorAll(".highlight").forEach(el=>el.classList.remove("highlight"));
    }

    let selected=null;
    boardEl.addEventListener("pointerdown",(e)=>{
      const pieceEl=e.target.closest(".piece");
      if (!pieceEl) return;
      const parent=pieceEl.closest(".square");
      const from=coordToRC(parent.dataset.coord);
      const piece=gameState.board[from[0]][from[1]];
      if (!piece) return;
      if ((gameState.turn==="w"&&piece!==piece.toUpperCase())||(gameState.turn==="b"&&piece!==piece.toLowerCase())) return;
      const moves=generateMoves(gameState,from).filter(m=>{
        const test=cloneState(gameState);
        return movePiece(test,from,m);
      });
      if (!moves.length) return;
      clearHighlights();
      parent.classList.add("highlight");
      moves.forEach(m=>{
        const coord=rcToCoord(m);
        const sq=boardEl.querySelector(`[data-coord="${coord}"]`);
        if (sq) sq.classList.add("highlight");
      });
      selected={from,moves};
    });

    boardEl.addEventListener("pointerup",(e)=>{
      if (!selected) return;
      const under=document.elementFromPoint(e.clientX,e.clientY);
      const dest=under?.closest(".square");
      if (!dest){ clearHighlights(); selected=null; return;}
      const to=coordToRC(dest.dataset.coord);
      const moved=movePiece(gameState,selected.from,to);
      if (moved) playMoveTone();
      else playClick();
      render(gameState);
      selected=null;
      clearHighlights();
    });

    // Simple confetti fallback (reuse from earlier)
    function launchConfetti(){
      const count=100;
      for (let i=0;i<count;i++){
        const el=document.createElement("div");
        el.style.position="fixed";
        el.style.width="8px";
        el.style.height="8px";
        el.style.background=`hsl(${Math.random()*360},80%,65%)`;
        el.style.borderRadius="50%";
        el.style.left=Math.random()*100+"%";
        el.style.top="-10px";
        el.style.opacity=1;
        el.style.pointerEvents="none";
        el.style.transition="transform 2s ease-out, opacity 2s ease-out";
        document.body.appendChild(el);
        const dx=(Math.random()-0.5)*100;
        const dy= window.innerHeight + 20;
        requestAnimationFrame(()=>{
          el.style.transform=`translate(${dx}px,${dy}px) rotate(${Math.random()*720}deg)`;
          el.style.opacity=0;
        });
        setTimeout(()=>el.remove(),2000);
      }
    }

    document.getElementById("start-btn").addEventListener("click",()=>{
      playClick();
      // ensure audio unlocked
      ensureCtx();
      playPinDrop();
      gameState = loadFEN(initialFEN);
      render(gameState);
      document.getElementById("board-container").style.display="block";
      document.getElementById("start-msg").textContent="Game started.";
    });
  </script>
</body>
</html>
